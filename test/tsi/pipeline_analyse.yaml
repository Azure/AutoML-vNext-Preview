name: AML_TSI_Analysis_VERSION_REPLACEMENT_STRING
experiment_name: AML_TSI_VERSION_REPLACEMENT_STRING
type: pipeline_job

inputs:
  target_column_name: income
  my_training_data:
    data: azureml:Adult_Train_PQ
    mode: mount
  my_test_data:
    data: azureml:Adult_Test_PQ
    mode: mount

outputs:
  my_model_directory:
    data:
      datastore: azureml:workspaceblobstore
  ma_info:
    data:
      datastore: azureml:workspaceblobstore
  model_info:
    data:
      datastore: azureml:workspaceblobstore

defaults:
  component_job:
    datastore: azureml:workspaceblobstore
    compute:
      target: azureml:cpucluster
    environment: azureml:AzureML-AutoML-DNN:85

jobs:
  train-model-job:
    component:
      type: autotrain_component
      id: azureml://AutoTrain
    inputs:
      task: classification
      primary_metric: average_precision_score_weighted
      log_verbosity: info
      timeout_minutes: 15
      max_concurrent_trials: 6
      enable_early_termination: true
      trial_timeout_minutes: 15
      training:
        dataset: ${{inputs.my_training_data}}
      validation:
        validation_data_size: 0.3
      target_column_name: ${{inputs.target_column_name}}
      featurization_config: auto
      enable_dnn_training: true
      target: azureml:cpucluster
      properties:
        _automl_internal_save_mlflow: 'True'
    outputs:
      model_output: ${{outputs.my_model_directory}}

  register-model-job:
    type: component_job
    component: azureml:RegisterModel:VERSION_REPLACEMENT_STRING
    inputs:
      model_input_path: ${{jobs.train-model-job.outputs.model_output}}
      model_base_name: component_registered_lr_01
    outputs:
      model_info_output_path: ${{outputs.model_info}}

  create-tsi-job:
    type: component_job
    component: azureml:AzureMLTestSetIngestion:VERSION_REPLACEMENT_STRING
    inputs:
      task_type: classification
      test_dataset: ${{inputs.my_test_data}}
      target_column_name: ${{inputs.target_column_name}}
      model_uri: ${{outputs.model_info}}
      automl-run-id: ${{jobs.train-model-job.name}}
    outputs:
      model_analysis_info: ${{outputs.ma_info}}
